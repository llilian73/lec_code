# 内存优化说明

## 问题分析

根据错误日志分析，主要问题是**内存分配失败**：

```
Unable to allocate 274. KiB for an array with shape (4, 8760) and data type float64
Unable to allocate 68.4 KiB for an array with shape (8760,) and data type float64
```

## 优化策略

### 1. 减少批量大小
- **原设置**：BATCH_SIZE = 100
- **优化后**：BATCH_SIZE = 20
- **内存使用高时**：自动调整为 10

### 2. 减少并行进程数
- **原设置**：MAX_WORKERS = 8
- **优化后**：MAX_WORKERS = 4
- **内存使用高时**：自动调整为 2

### 3. 内存数据类型优化
- **原设置**：使用 float64
- **优化后**：使用 float32（节省50%内存）
- **数组处理**：直接使用numpy数组，避免DataFrame额外开销

### 4. 内存管理优化
- **立即释放**：处理完每个点后立即删除大对象
- **强制垃圾回收**：每10个批次执行一次gc.collect()
- **内存监控**：实时监控内存使用率
- **动态调整**：根据内存使用情况动态调整参数

## 配置参数

```python
# 批量处理配置
BATCH_SIZE = 20   # 批量处理大小 - 减少内存使用
MAX_WORKERS = 4   # 最大工作线程数 - 减少并行度
MEMORY_THRESHOLD = 0.7  # 内存使用阈值 - 更保守
```

## 内存优化函数

### 1. 优化的BAIT计算
```python
def calculate_bait_for_point(climate_df):
    # 使用float32节省内存
    temperature = climate_df['T2M'].values.astype(np.float32)
    # 立即释放大对象
    del weather_df
```

### 2. 批量处理优化
```python
def process_batch_points(points_batch):
    # 逐个处理点，避免内存累积
    for point in points_batch:
        # 处理完成后立即释放内存
        del bait, energy_results, daily_bait
        gc.collect()
```

### 3. 内存监控
```python
def check_memory_usage():
    memory = psutil.virtual_memory()
    return memory.percent / 100.0
```

## 预期效果

### 内存使用减少
- **批量大小减少**：从100个点减少到20个点，内存使用减少80%
- **数据类型优化**：使用float32替代float64，内存使用减少50%
- **并行度降低**：从8个进程减少到4个进程，内存使用减少50%

### 总体内存优化
- **理论减少**：80% × 50% × 50% = 95%的内存使用减少
- **实际效果**：预计内存使用减少70-80%

## 使用建议

### 1. 系统要求
- **最低内存**：8GB
- **推荐内存**：16GB
- **CPU核心**：4核以上

### 2. 参数调整
如果仍然遇到内存问题，可以进一步调整：

```python
# 更保守的设置
BATCH_SIZE = 10
MAX_WORKERS = 2
MEMORY_THRESHOLD = 0.6
```

### 3. 监控指标
- **内存使用率**：应保持在70%以下
- **CPU利用率**：目标50-70%
- **处理速度**：可能略有下降，但更稳定

## 故障排除

### 1. 内存不足
- 减少BATCH_SIZE到10或5
- 减少MAX_WORKERS到2或1
- 检查系统其他程序的内存使用

### 2. 处理速度慢
- 适当增加BATCH_SIZE（在内存允许范围内）
- 增加MAX_WORKERS（在内存允许范围内）
- 使用SSD存储提高I/O性能

### 3. 进程崩溃
- 检查数据文件完整性
- 减少并行度
- 增加错误处理和重试机制
